<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Earthquake 3D Showcase</title>

<!-- Prevent favicon 404 -->
<link rel="icon" href="data:,">

<!-- MapLibre -->
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- deck.gl -->
<script src="https://cdn.jsdelivr.net/npm/deck.gl@8.9.34/dist.min.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: system-ui, sans-serif;
}

#map {
  width: 100vw;
  height: 100vh;
}

.panel {
  position: absolute;
  background: rgba(15,15,15,0.92);
  color: #ddd;
  padding: 12px;
  border-radius: 6px;
  font-size: 12px;
  z-index: 10;
}

#controls { top: 20px; left: 20px; width: 260px; }
#stats { top: 20px; right: 20px; width: 220px; }
#metadata { bottom: 20px; left: 20px; width: 340px; }
#infobox { bottom: 20px; right: 20px; width: 280px; }
#legend { bottom: 20px; left: 50%; transform: translateX(-50%); width: 220px; }

.legend-row {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}

.color-box {
  width: 14px;
  height: 14px;
  margin-right: 6px;
  border-radius: 2px;
}

button, select {
  width: 100%;
  margin-top: 6px;
  padding: 6px;
  background: #222;
  color: #fff;
  border: 1px solid #444;
  cursor: pointer;
}

button:hover { background: #333; }

input { width: 100%; }
</style>
</head>

<body>

<div id="map"></div>

<div id="controls" class="panel">
<strong>Filters</strong><br><br>

<label>Minimum magnitude</label>
<input id="magSlider" type="range" min="0" max="8" step="0.1" value="0">
<div>Value: <span id="magValue">0.0</span></div>

<br>

<label>Time window (days)</label>
<input id="timeSlider" type="range" min="1" max="30" step="1" value="30">
<div>Last <span id="timeValue">30</span> days</div>

<br>

<label>Color encoding</label>
<select id="colorMode">
  <option value="mag">Magnitude</option>
  <option value="depth">Depth</option>
</select>
</div>

<div id="stats" class="panel">
<strong>Live Stats</strong>
<div id="statsContent">Loading...</div>
</div>

<div id="metadata" class="panel">
<h3>Earthquake 3D Showcase</h3>
<p><strong>Date interval:</strong><br>
<span id="dateInterval">Loading...</span></p>
</div>

<div id="infobox" class="panel">
<strong>Earthquake details</strong>
<div id="infoContent">Click a column</div>
</div>

<div id="legend" class="panel">
<strong>Legend</strong>
<div id="legendContent"></div>
</div>

<script>
/* ===============================
   INITIALIZE MAP
=================================*/
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  center: [12, 50],
  zoom: 3.8,
  pitch: 60,
  bearing: -20,
  antialias: true
});

map.addControl(new maplibregl.NavigationControl());

/* ===============================
   TECTONIC PLATES
=================================*/
map.on('load', () => {
  map.addSource('plates', {
    type: 'geojson',
    data: 'https://raw.githubusercontent.com/fraxen/tectonicplates/master/GeoJSON/PB2002_boundaries.json'
  });

  map.addLayer({
    id: 'plates-line',
    type: 'line',
    source: 'plates',
    paint: {
      'line-color': '#00bcd4',
      'line-width': 2,
      'line-opacity': 0.8
    }
  });
});

/* ===============================
   DOM REFERENCES
=================================*/
const magSlider = document.getElementById("magSlider");
const magValue = document.getElementById("magValue");
const timeSlider = document.getElementById("timeSlider");
const timeValue = document.getElementById("timeValue");
const colorMode = document.getElementById("colorMode");

const legendContent = document.getElementById("legendContent");
const statsContent = document.getElementById("statsContent");
const dateInterval = document.getElementById("dateInterval");
const infoContent = document.getElementById("infoContent");

/* ===============================
   DATA + OVERLAY
=================================*/
let earthquakes = [];
let overlay = null;

fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson')
  .then(r => r.json())
  .then(data => {
    earthquakes = data.features;
    updateLayer();
  });

/* ===============================
   LEGEND
=================================*/
function updateLegend(mode) {
  if (mode === "depth") {
    legendContent.innerHTML = `
      <div class="legend-row"><div class="color-box" style="background:rgb(240,220,140)"></div>Shallow (&lt;100 km)</div>
      <div class="legend-row"><div class="color-box" style="background:rgb(0,120,220)"></div>Intermediate (100–300 km)</div>
      <div class="legend-row"><div class="color-box" style="background:rgb(120,0,180)"></div>Deep (&gt;300 km)</div>
    `;
  } else {
    legendContent.innerHTML = `
      <div class="legend-row"><div class="color-box" style="background:rgb(240,220,140)"></div>Mw &lt; 4</div>
      <div class="legend-row"><div class="color-box" style="background:rgb(240,160,60)"></div>Mw 4–6</div>
      <div class="legend-row"><div class="color-box" style="background:rgb(220,60,60)"></div>Mw ≥ 6</div>
    `;
  }
}

/* ===============================
   UPDATE LAYER
=================================*/
function updateLayer() {

  const minMag = parseFloat(magSlider.value);
  const days = parseInt(timeSlider.value);
  const cutoff = Date.now() - days * 86400000;

  const now = new Date();
  const startDate = new Date(cutoff);
  const format = d => d.toISOString().split('T')[0];
  dateInterval.textContent = `${format(startDate)} → ${format(now)}`;

  const filtered = earthquakes.filter(d =>
    (d.properties.mag || 0) >= minMag &&
    d.properties.time >= cutoff
  );

  updateStats(filtered);

  const mode = colorMode.value;
  updateLegend(mode);

  const layer = new deck.ColumnLayer({
    id: 'earthquakes',
    data: filtered,
    radius: 10000,
    extruded: true,
    elevationScale: 8000,
    diskResolution: 12,

    getPosition: d => d.geometry.coordinates,
    getElevation: d => d.properties.mag || 0,

    getFillColor: d => {
      const mag = d.properties.mag || 0;
      const depth = d.geometry.coordinates[2] || 0;

      if (mode === "depth") {
        if (depth > 300) return [120,0,180];
        if (depth > 100) return [0,120,220];
        return [240,220,140];
      } else {
        if (mag >= 6) return [220,60,60];
        if (mag >= 4) return [240,160,60];
        return [240,220,140];
      }
    },

    pickable: true,

    onClick: ({object}) => {
      if (!object) return;

      const coords = object.geometry.coordinates;
      const date = new Date(object.properties.time);

      map.flyTo({
        center: coords,
        zoom: 6,
        pitch: 70,
        speed: 0.8
      });

      infoContent.innerHTML = `
        <p><strong>Magnitude:</strong> ${object.properties.mag}</p>
        <p><strong>Depth:</strong> ${coords[2]} km</p>
        <p><strong>Date:</strong><br>${date.toUTCString()}</p>
        <p><strong>Location:</strong><br>${object.properties.place}</p>
      `;
    }
  });

  if (!overlay) {
    overlay = new deck.MapboxOverlay({ layers: [layer] });
    map.addControl(overlay);
  } else {
    overlay.setProps({ layers: [layer] });
  }
}

/* ===============================
   STATS
=================================*/
function updateStats(data) {
  if (!data.length) {
    statsContent.innerHTML = "No events";
    return;
  }

  const mags = data.map(d => d.properties.mag || 0);
  const maxMag = Math.max(...mags);
  const avgMag = (mags.reduce((a,b)=>a+b,0)/mags.length).toFixed(2);

  statsContent.innerHTML = `
    Total: ${data.length}<br>
    Max Mw: ${maxMag}<br>
    Avg Mw: ${avgMag}
  `;
}

/* ===============================
   UI EVENTS
=================================*/
magSlider.addEventListener("input", () => {
  magValue.textContent = parseFloat(magSlider.value).toFixed(1);
  updateLayer();
});

timeSlider.addEventListener("input", () => {
  timeValue.textContent = timeSlider.value;
  updateLayer();
});

colorMode.addEventListener("change", updateLayer);

updateLegend("mag");
</script>

</body>
</html>
