<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Earthquake Intensity Map</title>

  <!-- MapLibre GL (free, no API key) -->
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <link
    href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
    rel="stylesheet"
  />

  <!-- deck.gl -->
  <script src="https://unpkg.com/deck.gl@8.9.34/dist.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(20, 20, 20, 0.9);
      color: #fff;
      padding: 12px;
      border-radius: 4px;
      z-index: 10;
      font-size: 13px;
    }

    #controls input {
      width: 160px;
    }

    #metadata {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 320px;
      background: rgba(15, 15, 15, 0.9);
      color: #ddd;
      padding: 14px;
      border-radius: 4px;
      z-index: 10;
      font-size: 12px;
      line-height: 1.45;
    }

    #metadata h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #fff;
    }

    #metadata p {
      margin: 6px 0;
    }

    #metadata ul {
      padding-left: 0;
      margin: 6px 0 0 0;
    }

    #metadata li {
      list-style: none;
      margin: 2px 0;
    }

    #metadata .note {
      font-size: 11px;
      color: #aaa;
      margin-top: 8px;
    }
  </style>
</head>

<body>

<div id="map"></div>

<!-- Controls -->
<div id="controls">
  <div><strong>Minimum magnitude</strong></div>
  <input
    id="magSlider"
    type="range"
    min="0"
    max="8"
    step="0.1"
    value="0"
  />
  <div>Value: <span id="magValue">0.0</span></div>
</div>

<!-- Metadata panel -->
<div id="metadata">
  <h3>3D Earthquake Intensity Map</h3>

  <p>
    Interactive 3D visualization of global seismic activity.
    Vertical extrusion and color encode earthquake magnitude.
  </p>

  <p>
    <strong>Data source:</strong><br>
    USGS Earthquake Catalog
  </p>

  <p>
    <strong>Temporal coverage:</strong><br>
    Last 30 days (rolling window)
  </p>

  <p>
    <strong>Visual encoding:</strong><br>
    Height & color → Moment magnitude (Mw)
  </p>

  <p><strong>Magnitude classes:</strong></p>
  <ul>
    <li><span style="color:#dc3c3c;">■</span> Mw ≥ 6.0</li>
    <li><span style="color:#f0a03c;">■</span> 4.0 ≤ Mw &lt; 6.0</li>
    <li><span style="color:#f0dc8c;">■</span> Mw &lt; 4.0</li>
  </ul>

  <p class="note">
    Heights are visually exaggerated for interpretability.
    This visualization is intended for exploratory analysis only.
  </p>
</div>

<script>
  // ---------------------------------------------------------------------------
  // 1. Create MapLibre map
  // ---------------------------------------------------------------------------
  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
    center: [0, 20],
    zoom: 1.8,
    pitch: 60,
    bearing: -20,
    antialias: true
  });

  map.addControl(new maplibregl.NavigationControl());

  // ---------------------------------------------------------------------------
  // 2. Globals
  // ---------------------------------------------------------------------------
  let earthquakes = [];
  let overlay = null;

  // ---------------------------------------------------------------------------
  // 3. Fetch USGS earthquake data
  // ---------------------------------------------------------------------------
  fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson')
    .then(response => response.json())
    .then(data => {
      earthquakes = data.features;
      updateLayer(0);
    })
    .catch(err => {
      console.error('Failed to load earthquake data', err);
    });

  // ---------------------------------------------------------------------------
  // 4. Build / update deck.gl layer
  // ---------------------------------------------------------------------------
  function updateLayer(minMag) {
    const filtered = earthquakes.filter(
      d => (d.properties.mag || 0) >= minMag
    );

    const layer = new deck.ColumnLayer({
      id: 'earthquakes',
      data: filtered,

      diskResolution: 12,
      radius: 20000,
      extruded: true,
      elevationScale: 20000,

      getPosition: d => d.geometry.coordinates,
      getElevation: d => d.properties.mag || 0,

      getFillColor: d => {
        const m = d.properties.mag || 0;
        if (m >= 6) return [220, 60, 60];
        if (m >= 4) return [240, 160, 60];
        return [240, 220, 140];
      },

      pickable: true
    });

    if (!overlay) {
      overlay = new deck.MapboxOverlay({
        layers: [layer]
      });
      map.addControl(overlay);
    } else {
      overlay.setProps({ layers: [layer] });
    }
  }

  // ---------------------------------------------------------------------------
  // 5. Slider interaction
  // ---------------------------------------------------------------------------
  const slider = document.getElementById('magSlider');
  const label = document.getElementById('magValue');

  slider.addEventListener('input', () => {
    const val = parseFloat(slider.value);
    label.textContent = val.toFixed(1);
    updateLayer(val);
  });
</script>

</body>
</html>
