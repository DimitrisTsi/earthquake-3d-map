<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Earthquake 3D Showcase</title>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>

<script src="https://unpkg.com/deck.gl@8.9.34/dist.min.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: system-ui, sans-serif;
}

#map {
  width: 100vw;
  height: 100vh;
}

.panel {
  position: absolute;
  background: rgba(15,15,15,0.92);
  color: #ddd;
  padding: 12px;
  border-radius: 6px;
  font-size: 12px;
  z-index: 10;
}

#controls { top: 20px; left: 20px; width: 260px; }
#stats { top: 20px; right: 20px; width: 220px; }
#metadata { bottom: 20px; left: 20px; width: 340px; }
#infobox { bottom: 20px; right: 20px; width: 280px; }

button, select {
  width: 100%;
  margin-top: 6px;
  padding: 6px;
  background: #222;
  color: #fff;
  border: 1px solid #444;
  cursor: pointer;
}

button:hover { background: #333; }

input { width: 100%; }
</style>
</head>

<body>

<div id="map"></div>

<div id="controls" class="panel">
<strong>Filters</strong><br><br>

<label>Minimum magnitude</label>
<input id="magSlider" type="range" min="0" max="8" step="0.1" value="0">
<div>Value: <span id="magValue">0.0</span></div>

<br>

<label>Time window (days)</label>
<input id="timeSlider" type="range" min="1" max="30" step="1" value="30">
<div>Last <span id="timeValue">30</span> days</div>

<button id="playBtn">▶ Play Time</button>

<br>

<label>Color encoding</label>
<select id="colorMode">
  <option value="mag">Magnitude</option>
  <option value="depth">Depth</option>
</select>
</div>

<div id="stats" class="panel">
<strong>Live Stats</strong>
<div id="statsContent">Loading...</div>
</div>

<div id="metadata" class="panel">
<h3>Earthquake 3D Showcase</h3>
<p><strong>Date interval:</strong><br>
<span id="dateInterval">Loading...</span></p>
<p>USGS 30-day feed · PB2002 tectonic plates</p>
</div>

<div id="infobox" class="panel">
<strong>Earthquake details</strong>
<div id="infoContent">Click a column</div>
</div>

<script>
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  center: [12, 50],
  zoom: 3.8,
  pitch: 60,
  bearing: -20,
  antialias: true,
  preserveDrawingBuffer: true
});

map.addControl(new maplibregl.NavigationControl());

map.on('load', () => {
  map.addSource('plates', {
    type: 'geojson',
    data: 'https://raw.githubusercontent.com/fraxen/tectonicplates/master/GeoJSON/PB2002_boundaries.json'
  });

  map.addLayer({
    id: 'plates-line',
    type: 'line',
    source: 'plates',
    paint: {
      'line-color': '#00bcd4',
      'line-width': 1.5,
      'line-opacity': 0.6
    }
  });
});

let earthquakes = [];
let overlay = null;
let playing = false;
let playInterval = null;

fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson')
  .then(r => r.json())
  .then(data => {
    earthquakes = data.features;
    updateLayer();
  });

function updateLayer() {
  const minMag = parseFloat(magSlider.value);
  const days = parseInt(timeSlider.value);
  const cutoff = Date.now() - days * 86400000;

  const now = new Date();
  const startDate = new Date(cutoff);
  const format = d => d.toISOString().split('T')[0];
  dateInterval.textContent = `${format(startDate)} → ${format(now)}`;

  const filtered = earthquakes.filter(d =>
    (d.properties.mag || 0) >= minMag &&
    d.properties.time >= cutoff
  );

  updateStats(filtered);

  const colorMode = document.getElementById("colorMode").value;

  const layer = new deck.ColumnLayer({
    id: 'earthquakes',
    data: filtered,
    radius: 10000,
    diskResolution: 12,
    extruded: true,
    elevationScale: 8000,

    getPosition: d => d.geometry.coordinates,
    getElevation: d => d.properties.mag || 0,

    getFillColor: d => {
      const mag = d.properties.mag || 0;
      const depth = d.geometry.coordinates[2] || 0;

      if (colorMode === "depth") {
        if (depth > 300) return [120, 0, 180];
        if (depth > 100) return [0, 120, 220];
        return [240, 220, 140];
      } else {
        if (mag >= 6) return [220, 60, 60];
        if (mag >= 4) return [240, 160, 60];
        return [240, 220, 140];
      }
    },

    pickable: true,

    onClick: ({object}) => {
      if (!object) return;

      const coords = object.geometry.coordinates;
      const date = new Date(object.properties.time);

      map.flyTo({
        center: coords,
        zoom: 6,
        pitch: 70,
        speed: 0.8
      });

      infoContent.innerHTML = `
        <p><strong>Magnitude:</strong> ${object.properties.mag}</p>
        <p><strong>Depth:</strong> ${coords[2]} km</p>
        <p><strong>Date:</strong><br>${date.toUTCString()}</p>
        <p><strong>Location:</strong><br>${object.properties.place}</p>
      `;
    }
  });

  if (!overlay) {
    overlay = new deck.MapboxOverlay({ layers: [layer] });
    map.addControl(overlay);
  } else {
    overlay.setProps({ layers: [layer] });
  }
}

function updateStats(data) {
  if (!data.length) {
    statsContent.innerHTML = "No events";
    return;
  }

  const mags = data.map(d => d.properties.mag || 0);
  const maxMag = Math.max(...mags);
  const avgMag = (mags.reduce((a,b)=>a+b,0)/mags.length).toFixed(2);

  statsContent.innerHTML = `
    Total: ${data.length}<br>
    Max Mw: ${maxMag}<br>
    Avg Mw: ${avgMag}
  `;
}

magSlider.oninput = () => {
  magValue.textContent = parseFloat(magSlider.value).toFixed(1);
  updateLayer();
};

timeSlider.oninput = () => {
  timeValue.textContent = timeSlider.value;
  updateLayer();
};

colorMode.onchange = updateLayer;

playBtn.onclick = () => {
  if (!playing) {
    playing = true;
    playBtn.textContent = "⏸ Pause";
    playInterval = setInterval(() => {
      if (timeSlider.value > 1) {
        timeSlider.value--;
        timeValue.textContent = timeSlider.value;
        updateLayer();
      }
    }, 600);
  } else {
    playing = false;
    playBtn.textContent = "▶ Play Time";
    clearInterval(playInterval);
  }
};
</script>

</body>
</html>
