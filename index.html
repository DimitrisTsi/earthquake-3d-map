<script>
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  center: [12, 50],
  zoom: 3.8,
  pitch: 60,
  bearing: -20,
  antialias: true
});

map.addControl(new maplibregl.NavigationControl());

let earthquakes = [];
let overlay = null;
let playing = false;
let playInterval = null;

fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson')
  .then(r => r.json())
  .then(data => {
    earthquakes = data.features;
    updateLayer();
  });

function updateLegend(mode) {
  if (mode === "depth") {
    legendContent.innerHTML = `
      <div class="legend-row"><div class="color-box" style="background:rgb(240,220,140)"></div>Shallow (&lt;100 km)</div>
      <div class="legend-row"><div class="color-box" style="background:rgb(0,120,220)"></div>Intermediate (100–300 km)</div>
      <div class="legend-row"><div class="color-box" style="background:rgb(120,0,180)"></div>Deep (&gt;300 km)</div>
    `;
  } else {
    legendContent.innerHTML = `
      <div class="legend-row"><div class="color-box" style="background:rgb(240,220,140)"></div>Mw &lt; 4</div>
      <div class="legend-row"><div class="color-box" style="background:rgb(240,160,60)"></div>Mw 4–6</div>
      <div class="legend-row"><div class="color-box" style="background:rgb(220,60,60)"></div>Mw ≥ 6</div>
    `;
  }
}

function updateLayer() {
  const minMag = parseFloat(magSlider.value);
  const days = parseInt(timeSlider.value);
  const cutoff = Date.now() - days * 86400000;

  const now = new Date();
  const startDate = new Date(cutoff);
  const format = d => d.toISOString().split('T')[0];
  dateInterval.textContent = `${format(startDate)} → ${format(now)}`;

  const filtered = earthquakes.filter(d =>
    (d.properties.mag || 0) >= minMag &&
    d.properties.time >= cutoff
  );

  updateStats(filtered);

  const mode = colorMode.value;
  updateLegend(mode);

  const layer = new deck.ColumnLayer({
    id: 'earthquakes',
    data: filtered,

    radius: 10000,
    extruded: true,
    elevationScale: 8000,
    diskResolution: 12,

    getPosition: d => d.geometry.coordinates,
    getElevation: d => d.properties.mag || 0,

    getFillColor: d => {
      const mag = d.properties.mag || 0;
      const depth = d.geometry.coordinates[2] || 0;

      if (mode === "depth") {
        if (depth > 300) return [120,0,180];
        if (depth > 100) return [0,120,220];
        return [240,220,140];
      } else {
        if (mag >= 6) return [220,60,60];
        if (mag >= 4) return [240,160,60];
        return [240,220,140];
      }
    },

    pickable: true,   // ← THIS WAS MISSING

    onClick: ({object}) => {
      if (!object) return;

      const coords = object.geometry.coordinates;
      const date = new Date(object.properties.time);

      map.flyTo({
        center: coords,
        zoom: 6,
        pitch: 70,
        speed: 0.8
      });

      infoContent.innerHTML = `
        <p><strong>Magnitude:</strong> ${object.properties.mag}</p>
        <p><strong>Depth:</strong> ${coords[2]} km</p>
        <p><strong>Date:</strong><br>${date.toUTCString()}</p>
        <p><strong>Location:</strong><br>${object.properties.place}</p>
      `;
    }
  });

  if (!overlay) {
    overlay = new deck.MapboxOverlay({ layers: [layer] });
    map.addControl(overlay);
  } else {
    overlay.setProps({ layers: [layer] });
  }
}

function updateStats(data) {
  if (!data.length) {
    statsContent.innerHTML = "No events";
    return;
  }

  const mags = data.map(d => d.properties.mag || 0);
  const maxMag = Math.max(...mags);
  const avgMag = (mags.reduce((a,b)=>a+b,0)/mags.length).toFixed(2);

  statsContent.innerHTML = `
    Total: ${data.length}<br>
    Max Mw: ${maxMag}<br>
    Avg Mw: ${avgMag}
  `;
}

magSlider.oninput = () => {
  magValue.textContent = parseFloat(magSlider.value).toFixed(1);
  updateLayer();
};

timeSlider.oninput = () => {
  timeValue.textContent = timeSlider.value;
  updateLayer();
};

colorMode.onchange = updateLayer;

updateLegend("mag");
</script>
